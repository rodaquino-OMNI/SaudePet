name: Scheduled Jobs

on:
  schedule:
    # Process reminders every hour
    - cron: '0 * * * *'
    # Cleanup weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
    # Subscription check daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Job to run'
        required: true
        type: choice
        options:
          - reminders
          - cleanup
          - subscription-check

env:
  AWS_REGION: us-east-1

jobs:
  process-reminders:
    if: github.event.schedule == '0 * * * *' || github.event.inputs.job_type == 'reminders'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Trigger reminder processor
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.API_INTERNAL_TOKEN }}" \
            https://api.petvet.ai/internal/jobs/process-reminders)
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Request failed with status code: $http_code"
            exit 1
          fi
          echo "Reminder processing triggered successfully"

      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš¨ Scheduled reminder job failed! Check GitHub Actions for details."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  cleanup:
    if: github.event.schedule == '0 3 * * 0' || github.event.inputs.job_type == 'cleanup'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Run cleanup jobs
        run: |
          # Clean expired sessions
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.API_INTERNAL_TOKEN }}" \
            https://api.petvet.ai/internal/jobs/cleanup-sessions)
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Session cleanup failed with status code: $http_code"
            exit 1
          fi

          # Archive old consultations
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.API_INTERNAL_TOKEN }}" \
            https://api.petvet.ai/internal/jobs/archive-consultations)
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Consultation archiving failed with status code: $http_code"
            exit 1
          fi

          echo "Cleanup jobs completed successfully"

      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš¨ Scheduled cleanup job failed! Check GitHub Actions for details."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  subscription-check:
    if: github.event.schedule == '0 6 * * *' || github.event.inputs.job_type == 'subscription-check'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Check subscription renewals
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.API_INTERNAL_TOKEN }}" \
            https://api.petvet.ai/internal/jobs/check-subscriptions)
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Subscription check failed with status code: $http_code"
            exit 1
          fi
          echo "Subscription check completed successfully"

      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš¨ Scheduled subscription check failed! Check GitHub Actions for details."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
